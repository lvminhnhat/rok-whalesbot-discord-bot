{% extends "base.html" %}

{% block page_title %}Users Management{% endblock %}

{% block extra_css %}
<style>
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.control-buttons, .management-buttons {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
}

.btn-sm {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    transition: all 0.2s ease-in-out;
}

.btn-sm:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-sm:active {
    transform: translateY(0);
    box-shadow: none;
}

/* Better button colors */
.btn-success {
    background-color: #198754;
    border-color: #198754;
}

.btn-success:hover {
    background-color: #157347;
    border-color: #157347;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
}

.btn-danger:hover {
    background-color: #bb2d3b;
    border-color: #bb2d3b;
}

.btn-warning {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
}

.btn-warning:hover {
    background-color: #ffca2c;
    border-color: #ffca2c;
    color: #000;
}

.btn-outline-danger {
    color: #dc3545;
    border-color: #dc3545;
}

.btn-outline-danger:hover {
    background-color: #dc3545;
    border-color: #dc3545;
}

/* User avatar styling */
.bi-person-circle {
    flex-shrink: 0;
}

/* Loading state */
.table-hover tbody tr:hover {
    background-color: rgba(0,0,0,0.025);
}

/* Badge improvements */
.badge {
    font-size: 0.7rem;
    padding: 0.35em 0.6em;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .action-buttons {
        gap: 0.25rem;
    }

    .btn-sm {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
    }

    .control-buttons, .management-buttons {
        gap: 0.2rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label>Status Filter:</label>
                        <select class="form-select" id="filter-status" onchange="loadUsers()">
                            <option value="all">All</option>
                            <option value="RUNNING">Running</option>
                            <option value="STOPPED">Stopped</option>
                            <option value="EXPIRED">Expired</option>
                            <option value="ERROR">Error</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Expiry Filter:</label>
                        <select class="form-select" id="filter-expiry" onchange="loadUsers()">
                            <option value="all">All</option>
                            <option value="expired">Expired</option>
                            <option value="expiring_7">Expiring in 7 days</option>
                            <option value="expiring_30">Expiring in 30 days</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>Search:</label>
                        <input type="text" class="form-control" id="search-input" placeholder="Search by name or ID..." onkeyup="filterTable()">
                    </div>
                    <div class="col-md-2">
                        <label>Bulk Actions:</label>
                        <div class="d-grid gap-2">
                            <button class="btn btn-warning btn-sm" onclick="bulkUnlinkExpired()">
                                <i class="bi bi-link-45deg"></i> Unlink Expired
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="bulkDeleteExpired()">
                                <i class="bi bi-trash3"></i> Delete Expired
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people"></i> Users List</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="users-table">
                        <thead class="table-light">
                            <tr>
                                <th style="min-width: 200px;">Discord Name</th>
                                <th style="min-width: 100px;">Status</th>
                                <th style="min-width: 150px;">Emulator</th>
                                <th style="min-width: 120px;">End Date</th>
                                <th style="min-width: 100px;">Days Left</th>
                                <th style="min-width: 400px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-body">
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    Loading users...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="addDaysModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Days</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="addDaysUserId">
                <div class="mb-3">
                    <label class="form-label">Days to add:</label>
                    <input type="number" class="form-control" id="addDaysValue" min="1" value="30">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddDays()">Add Days</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="setExpiryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Expiry Date</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="setExpiryUserId">
                <div class="mb-3">
                    <label class="form-label">Expiry date:</label>
                    <input type="date" class="form-control" id="setExpiryValue">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitSetExpiry()">Set Expiry</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let usersData = [];

async function loadUsers() {
    const status = document.getElementById('filter-status').value;
    const expiry = document.getElementById('filter-expiry').value;
    
    try {
        const response = await fetch(`/api/users?status=${status}&expiry=${expiry}`);
        const data = await response.json();
        usersData = data.users;
        
        renderUsers(usersData);
    } catch (error) {
        console.error('Error loading users:', error);
        showToast('Error loading users: ' + error.message, 'danger');
    }
}

function renderUsers(users) {
    const tbody = document.getElementById('users-body');
    tbody.innerHTML = '';

    if (users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-5">
                    <div class="mb-3">
                        <i class="bi bi-people" style="font-size: 3rem;"></i>
                    </div>
                    <div class="fw-semibold mb-2">No users found</div>
                    <div class="small">Try adjusting your filters or check if there are any users in the system.</div>
                </td>
            </tr>
        `;
        return;
    }
    
    users.forEach(user => {
        const row = document.createElement('tr');
        
        const statusBadge = getStatusBadge(user.status);
        const endDate = user.subscription.end_at ? new Date(user.subscription.end_at).toLocaleDateString() : '--';
        
            // Emulator info
        let emulatorInfo = '<span class="badge bg-secondary">Unlinked</span>';
        if (user.emulator_index !== -1) {
            const emulatorName = user.emulator_name || `Emulator ${user.emulator_index}`;
            emulatorInfo = `<span class="badge bg-info">#${user.emulator_index}</span> ${escapeHtml(emulatorName)}`;
        }

        row.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    <div class="me-2">
                        <i class="bi bi-person-circle text-primary" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div class="fw-semibold">${escapeHtml(user.discord_name)}</div>
                        <small class="text-muted"><code>${user.discord_id}</code></small>
                    </div>
                </div>
            </td>
            <td>${statusBadge}</td>
            <td>${emulatorInfo}</td>
            <td>${endDate}</td>
            <td><span class="badge ${user.subscription.days_left > 7 ? 'bg-success' : 'bg-warning'}">${user.subscription.days_left} days</span></td>
            <td>
                <div class="action-buttons">
                    <div class="control-buttons mb-2">
                        ${user.is_running
                            ? `<button class="btn btn-danger btn-sm me-1" onclick="stopUser('${user.discord_id}')" title="Stop Bot">
                                    <i class="bi bi-stop-fill"></i> Stop
                               </button>`
                            : `<button class="btn btn-success btn-sm me-1" onclick="startUser('${user.discord_id}')" title="Start Bot">
                                    <i class="bi bi-play-fill"></i> Start
                               </button>`
                        }
                        ${user.emulator_index !== -1 ? `
                            <button class="btn btn-warning btn-sm" onclick="unlinkUser('${user.discord_id}', '${escapeHtml(user.discord_name)}')" title="Unlink from Emulator">
                                <i class="bi bi-link-45deg"></i> Unlink
                            </button>
                        ` : `
                            <span class="badge bg-secondary me-1">
                                <i class="bi bi-link-45deg"></i> Unlinked
                            </span>
                        `}
                    </div>
                    <div class="management-buttons">
                        <button class="btn btn-primary btn-sm me-1" onclick="showAddDaysModal('${user.discord_id}')" title="Add Days">
                            <i class="bi bi-plus-circle"></i> Days
                        </button>
                        <button class="btn btn-info btn-sm me-1" onclick="showSetExpiryModal('${user.discord_id}')" title="Set Expiry">
                            <i class="bi bi-calendar-date"></i> Date
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteUser('${user.discord_id}', '${escapeHtml(user.discord_name)}')" title="Delete User">
                            <i class="bi bi-trash3"></i> Delete
                        </button>
                    </div>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function filterTable() {
    const searchText = document.getElementById('search-input').value.toLowerCase();
    const filtered = usersData.filter(user => 
        user.discord_name.toLowerCase().includes(searchText) ||
        user.discord_id.includes(searchText)
    );
    renderUsers(filtered);
}

async function startUser(userId) {
    try {
        const response = await fetch(`/api/users/${userId}/start`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'danger');
        if (result.success) loadUsers();
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

async function stopUser(userId) {
    try {
        const response = await fetch(`/api/users/${userId}/stop`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'danger');
        if (result.success) loadUsers();
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

function showAddDaysModal(userId) {
    document.getElementById('addDaysUserId').value = userId;
    document.getElementById('addDaysValue').value = 30;
    new bootstrap.Modal(document.getElementById('addDaysModal')).show();
}

async function submitAddDays() {
    const userId = document.getElementById('addDaysUserId').value;
    const days = parseInt(document.getElementById('addDaysValue').value);
    
    try {
        const response = await fetch(`/api/users/${userId}/add_days`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({days})
        });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'danger');
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('addDaysModal')).hide();
            loadUsers();
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

function showSetExpiryModal(userId) {
    document.getElementById('setExpiryUserId').value = userId;
    document.getElementById('setExpiryValue').value = '';
    new bootstrap.Modal(document.getElementById('setExpiryModal')).show();
}

async function submitSetExpiry() {
    const userId = document.getElementById('setExpiryUserId').value;
    const date = document.getElementById('setExpiryValue').value;
    
    try {
        const response = await fetch(`/api/users/${userId}/set_expiry`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({date})
        });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'danger');
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('setExpiryModal')).hide();
            loadUsers();
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

async function revokeUser(userId, userName) {
    if (!confirm(`Are you sure you want to revoke access for ${userName}?`)) return;

    try {
        const response = await fetch(`/api/users/${userId}/revoke`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'danger');
        if (result.success) loadUsers();
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

async function unlinkUser(userId, userName) {
    if (!confirm(`Are you sure you want to unlink ${userName} from their emulator?`)) return;

    try {
        const response = await fetch(`/api/users/${userId}/unlink`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'danger');
        if (result.success) loadUsers();
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

async function deleteUser(userId, userName) {
    if (!confirm(`⚠️ WARNING: This will permanently delete ${userName} from the system. This action cannot be undone.\n\nAre you absolutely sure?`)) return;

    try {
        const response = await fetch(`/api/users/${userId}/delete`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'danger');
        if (result.success) loadUsers();
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

async function bulkUnlinkExpired() {
    const expiredCount = usersData.filter(u => u.subscription.is_expired && u.emulator_index !== -1).length;
    if (expiredCount === 0) {
        showToast('No expired users with emulators found', 'info');
        return;
    }

    if (!confirm(`⚠️ This will unlink ${expiredCount} expired users from their emulators.\n\nAre you sure?`)) return;

    try {
        showToast('Processing bulk unlink...', 'info');
        const response = await fetch('/api/users/bulk-unlink-expired', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();

        if (result.success) {
            showToast(result.message, 'success');
            loadUsers();
        } else {
            showToast(result.message, 'danger');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

async function bulkDeleteExpired() {
    const expiredCount = usersData.filter(u => u.subscription.is_expired).length;
    if (expiredCount === 0) {
        showToast('No expired users found', 'info');
        return;
    }

    if (!confirm(`⚠️ CRITICAL WARNING: This will permanently delete ${expiredCount} expired users from the system. This action cannot be undone.\n\nAre you absolutely sure?`)) return;

    try {
        showToast('Processing bulk deletion...', 'warning');
        const response = await fetch('/api/users/bulk-delete-expired', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();

        if (result.success) {
            showToast(result.message, 'success');
            loadUsers();
        } else {
            showToast(result.message, 'danger');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

loadUsers();
setupAutoRefresh(loadUsers, 10000);
</script>
{% endblock %}

