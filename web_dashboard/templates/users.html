{% extends "base.html" %}

{% block page_title %}Users Management{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label>Status Filter:</label>
                        <select class="form-select" id="filter-status" onchange="loadUsers()">
                            <option value="all">All</option>
                            <option value="RUNNING">Running</option>
                            <option value="STOPPED">Stopped</option>
                            <option value="EXPIRED">Expired</option>
                            <option value="ERROR">Error</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Expiry Filter:</label>
                        <select class="form-select" id="filter-expiry" onchange="loadUsers()">
                            <option value="all">All</option>
                            <option value="expired">Expired</option>
                            <option value="expiring_7">Expiring in 7 days</option>
                            <option value="expiring_30">Expiring in 30 days</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label>Search:</label>
                        <input type="text" class="form-control" id="search-input" placeholder="Search by name or ID..." onkeyup="filterTable()">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people"></i> Users List</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="users-table">
                        <thead>
                            <tr>
                                <th>Discord Name</th>
                                <th>Status</th>
                                <th>Emulator</th>
                                <th>End Date</th>
                                <th>Days Left</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-body">
                            <tr>
                                <td colspan="6" class="text-center text-muted">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="addDaysModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Days</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="addDaysUserId">
                <div class="mb-3">
                    <label class="form-label">Days to add:</label>
                    <input type="number" class="form-control" id="addDaysValue" min="1" value="30">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddDays()">Add Days</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="setExpiryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Expiry Date</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="setExpiryUserId">
                <div class="mb-3">
                    <label class="form-label">Expiry date:</label>
                    <input type="date" class="form-control" id="setExpiryValue">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitSetExpiry()">Set Expiry</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let usersData = [];

async function loadUsers() {
    const status = document.getElementById('filter-status').value;
    const expiry = document.getElementById('filter-expiry').value;
    
    try {
        const response = await fetch(`/api/users?status=${status}&expiry=${expiry}`);
        const data = await response.json();
        usersData = data.users;
        
        renderUsers(usersData);
    } catch (error) {
        console.error('Error loading users:', error);
        showToast('Error loading users: ' + error.message, 'danger');
    }
}

function renderUsers(users) {
    const tbody = document.getElementById('users-body');
    tbody.innerHTML = '';
    
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No users found</td></tr>';
        return;
    }
    
    users.forEach(user => {
        const row = document.createElement('tr');
        
        const statusBadge = getStatusBadge(user.status);
        const endDate = user.subscription.end_at ? new Date(user.subscription.end_at).toLocaleDateString() : '--';
        
        row.innerHTML = `
            <td>
                ${escapeHtml(user.discord_name)}<br>
                <small class="text-muted"><code>${user.discord_id}</code></small>
            </td>
            <td>${statusBadge}</td>
            <td><span class="badge bg-secondary">#${user.emulator_index}</span></td>
            <td>${endDate}</td>
            <td><span class="badge ${user.subscription.days_left > 7 ? 'bg-success' : 'bg-warning'}">${user.subscription.days_left} days</span></td>
            <td>
                <div class="btn-group btn-group-sm">
                    ${user.is_running 
                        ? `<button class="btn btn-danger" onclick="stopUser('${user.discord_id}')"><i class="bi bi-stop"></i></button>`
                        : `<button class="btn btn-success" onclick="startUser('${user.discord_id}')"><i class="bi bi-play"></i></button>`
                    }
                    <button class="btn btn-primary" onclick="showAddDaysModal('${user.discord_id}')"><i class="bi bi-plus"></i> Days</button>
                    <button class="btn btn-info" onclick="showSetExpiryModal('${user.discord_id}')"><i class="bi bi-calendar"></i></button>
                    <button class="btn btn-warning" onclick="revokeUser('${user.discord_id}', '${escapeHtml(user.discord_name)}')"><i class="bi bi-x"></i></button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function filterTable() {
    const searchText = document.getElementById('search-input').value.toLowerCase();
    const filtered = usersData.filter(user => 
        user.discord_name.toLowerCase().includes(searchText) ||
        user.discord_id.includes(searchText)
    );
    renderUsers(filtered);
}

async function startUser(userId) {
    try {
        const response = await fetch(`/api/users/${userId}/start`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'danger');
        if (result.success) loadUsers();
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

async function stopUser(userId) {
    try {
        const response = await fetch(`/api/users/${userId}/stop`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'danger');
        if (result.success) loadUsers();
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

function showAddDaysModal(userId) {
    document.getElementById('addDaysUserId').value = userId;
    document.getElementById('addDaysValue').value = 30;
    new bootstrap.Modal(document.getElementById('addDaysModal')).show();
}

async function submitAddDays() {
    const userId = document.getElementById('addDaysUserId').value;
    const days = parseInt(document.getElementById('addDaysValue').value);
    
    try {
        const response = await fetch(`/api/users/${userId}/add_days`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({days})
        });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'danger');
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('addDaysModal')).hide();
            loadUsers();
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

function showSetExpiryModal(userId) {
    document.getElementById('setExpiryUserId').value = userId;
    document.getElementById('setExpiryValue').value = '';
    new bootstrap.Modal(document.getElementById('setExpiryModal')).show();
}

async function submitSetExpiry() {
    const userId = document.getElementById('setExpiryUserId').value;
    const date = document.getElementById('setExpiryValue').value;
    
    try {
        const response = await fetch(`/api/users/${userId}/set_expiry`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({date})
        });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'danger');
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('setExpiryModal')).hide();
            loadUsers();
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

async function revokeUser(userId, userName) {
    if (!confirm(`Are you sure you want to revoke access for ${userName}?`)) return;
    
    try {
        const response = await fetch(`/api/users/${userId}/revoke`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await response.json();
        showToast(result.message, result.success ? 'success' : 'danger');
        if (result.success) loadUsers();
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

loadUsers();
setupAutoRefresh(loadUsers, 10000);
</script>
{% endblock %}

